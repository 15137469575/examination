<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="css/resetting.css" />
		<link rel="stylesheet" type="text/css" href="css/student.css" />
		<script src="js/jquery-3.6.0.js" type="text/javascript" charset="utf-8"></script>
		
		<script src="js/xlsx.js" type="text/javascript" charset="utf-8"></script>
		
		<!-- 这是缓存 -->
		<script type="text/javascript">
			window.onload = function() {
		
				var paperId = document.getElementById('paperId');
				var str = localStorage.getItem('id');
				if (str) {
					paperId.value = str;
					localStorage.removeItem('id');
				}
				window.onbeforeunload = function() {
					localStorage.setItem('id', paperId.value);
				}
			}
		</script>
		<!-- 这是添加表格 -->
		<script type="text/javascript">
			
		$(function(){
				// js读取解析Excel
				// 定义一个carData,用来保存读取到的数据
				
				var createExam = document.getElementById('createExam');
		
				createExam.onclick = function() {
					var form = {
						"examName": $("#object_select").val(),
						"paperId": $("#paperId").value,
						"invigilatorTeacherId": $("#teacherId").value,
						"remark":$("#normal").value,
						"examTime":$("#examTime").Value
					};
					$.get("/exam/insert", form, function(res) {
						var examId = document.getElementById('examId');
						examId.value = res;
						var carData;
						var  Cardata;
						$(document).ready(function() {
								
							var wb; //读取完成的数据
							var rABS = false; //是否将文件读取为二进制字符串
								
							function fixdata(data) { //文件流转BinaryString
								var o = "",
									l = 0,
									w = 10240;
								for (; l < data.byteLength / w; ++l) o += String.fromCharCode.apply(null, new Uint8Array(data
									.slice(l * w, l * w + w)));
								o += String.fromCharCode.apply(null, new Uint8Array(data.slice(l * w)));
								return o;
							}
								
							$("#file").change(function() {
						 	if (!this.files) {
									return;
								}
								var f = this.files[0];
								var reader = new FileReader();
								reader.onload = function(e) {
									var data = e.target.result;
									if (rABS) {
										wb = XLSX.read(btoa(fixdata(data)), {
											type: 'base64'
										});
									} else {
										wb = XLSX.read(data, {
											type: 'binary'
										});
									}
								
									// carData就是我们需要的JSON数据
									carData = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
									Cardata = new Array(carData.length);
									for(var i= 0 ; i< carData.length; i++){
										Cardata[i] = parseInt(carData[i].StudentId);
									}
									console.log(typeof(Cardata[0]));	
									$("#addStudent").on("click",function(){
										
										var form1 = {
											"examId" : $("#examId").val(),
											"studentId": Cardata
										};
									$.get("/examStudentConller/insert",form1,function(resg){
										alert("考生信息导入成功");
										var notice = document.getElementById('notice');
										notice.value = object_select.value + "将于" + examTime.value + "开考，请各位同学做好准备！";
											
										$("#issueNotice").on("click",function(){
											
											var form2 = {
												"examId":$("#examId").val(),
												"msg":notice.value
											};
											$.get("/msg/insert",form2,function(resj){
												alert("发布通知成功");
												
											})
											
										})
											
										})
										
									})
									
									
									
						   		
								};
								if (rABS) {
									reader.readAsArrayBuffer(f);
								} else {
									reader.readAsBinaryString(f);
								}
							})
								
						});
						
					})
				}
			})
		</script>
	</head>
	<body>

		<header class="mheader">
			<div class="welcom">
				欢迎来到线上考试平台
			</div>
			<div class="back">
				<a href="login.html">返回</a>
			</div>
		</header>

		

		<div class="mbody">
			<div class="left">
				
				<div>
					<a class="viewResults" href="createPaper.html">手动组卷</a>
				</div>
				<div>
					<a class="checkPaper" href="#">查看试卷</a>
				</div>
				<div>
					<a class="jionExame" href="createExam.html">创建考试</a>
				</div>
			</div>
			<div class="right">
				科目(必选):
				<select id="object_select" class="num_select">
					<option value='-1' style='display: none'></option>
					<option value="语文">语文</option>
					<option value="数学">数学</option>
					<option value="政治">政治</option>
					<option value="历史">历史</option>
					<option value="地理">地理</option>
					<option value="生物">生物</option>
				</select>
				教职工号：
				<input type="text" id="teacherId" />
				备注：
				<input type="text" id="normal" />
				试卷编号：
				<input type="text" readonly="readonly" id="paperId" value="" />
				考试时间：
				<input type="text"  id="examTime" placeholder="格式:yy/mm/dd/8:00PM" value="" />
				
				<button type="button" id="createExam">创建考试</button>
		
				<ul>
					<li>&nbsp;</li>
					
						考试编号：
						<input type="text" readonly="readonly" id="examId" value="" />
						导入考生名单：
						<input type="file" id="file" />
						<button type="button" id="addStudent">导入</button>
						<div id="car-list"></div>
						<li>&nbsp;</li>
						<input type="text" id="notice" style="width: 40%;" value="" />
						<button type="button" id="issueNotice">发布考试通知</button>
						<button type="button" id="issueExam">发布考试</button>
						
				</ul>
			</div>
		</div>

	</body>
</html>
